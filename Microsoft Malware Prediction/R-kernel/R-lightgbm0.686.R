library(lightgbm)
library(data.table)

#---------------------------
cat("Loading data...\n")

dt <- fread("train.csv", drop = "MachineIdentifier")
dt <- dt[sample(.N, .N %/% 2), ]

y <- dt[, HasDetections]
dt[, HasDetections := NULL]
N <- dt[, .N]

dt <- rbind(dt, fread("test.csv", drop = "MachineIdentifier"))

#---------------------------
cat("Adding features...\n")

dt[, asv_wig_f := .N / N, by = "AvSigVersion,Wdft_IsGamer"]

#---------------------------
cat("Converting character columns...\n")

cats <- names(which(sapply(dt, is.character)))
dt[, (cats) := lapply(.SD, function(x) as.integer(as.factor(x))), .SDcols = cats]  

dt <- data.matrix(dt)

rm(cats); invisible(gc())

#---------------------------
cat("Preparing data for boosting...\n")

tr <- lgb.Dataset(data = dt[1:N, ], label = y)
te <- dt[-(1:N), ]

rm(dt, y, N); invisible(gc())

#---------------------------
cat("Training model and predicting...\n")

subm <- fread("sample_submission.csv")
subm[, HasDetections := 0]

n_bags <- 3
for (i in seq(0.7, 0.9, length.out = n_bags)) {
  p <- list(boosting_type = "gbdt", 
            objective = "binary",
            metric = "auc", 
            nthread = 4, 
            learning_rate = 0.05, 
            max_depth = 5,
            num_leaves = 40,
            sub_feature = i, 
            sub_row = i, 
            bagging_freq = 1,
            lambda_l1 = 0.1, 
            lambda_l2 = 0.1)
  
  m_gbm <- lgb.train(p, tr, 5000,  verbose = -1)
  subm[, HasDetections := HasDetections + predict(m_gbm, te) / n_bags]
  
  rm(m_gbm); invisible(gc())
}

#---------------------------
cat("Making submission file...\n")

fwrite(subm, "ms_malware.csv")